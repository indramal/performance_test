name: Performance Benchmarks

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install Tuono CLI
        run: cargo install tuono --version 0.19.7

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wrk jq

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli

      - name: Cache Tuono dependencies
        uses: actions/cache@v3
        with:
          path: |
            tuono-test/target
            tuono-test/node_modules
          key: ${{ runner.os }}-tuono-${{ hashFiles('tuono-test/Cargo.lock', 'tuono-test/package-lock.json') }}

      - name: Cache Bun dependencies
        uses: actions/cache@v3
        with:
          path: bun-test/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('bun-test/package.json') }}

      - name: Cache Next.js dependencies
        uses: actions/cache@v3
        with:
          path: |
            nextjs-test/node_modules
            nextjs-test/.next
          key: ${{ runner.os }}-nextjs-${{ hashFiles('nextjs-test/package-lock.json') }}

      - name: Cache Astro CSR dependencies
        uses: actions/cache@v3
        with:
          path: astro-react-csr/node_modules
          key: ${{ runner.os }}-astro-csr-${{ hashFiles('astro-react-csr/package-lock.json') }}

      - name: Cache Astro Bun SSR dependencies
        uses: actions/cache@v3
        with:
          path: astro-react-bun-ssr/node_modules
          key: ${{ runner.os }}-astro-bun-ssr-${{ hashFiles('astro-react-bun-ssr/package.json') }}

      - name: Cache TanStack Start dependencies
        uses: actions/cache@v3
        with:
          path: tanstack-start-bun/node_modules
          key: ${{ runner.os }}-tanstack-${{ hashFiles('tanstack-start-bun/package.json') }}

      - name: Cache Askama dependencies
        uses: actions/cache@v3
        with:
          path: |
            astro-react-askama/node_modules
            astro-react-askama/target
          key: ${{ runner.os }}-askama-${{ hashFiles('astro-react-askama/package.json', 'astro-react-askama/Cargo.toml') }}

      - name: List repository contents
        run: |
          echo "Repository root contents:"
          ls -la
          echo ""
          echo "Checking for project directories:"
          [ -d "tuono-test" ] && echo "✓ tuono-test exists" || echo "✗ tuono-test missing"
          [ -d "bun-test" ] && echo "✓ bun-test exists" || echo "✗ bun-test missing"
          [ -d "nextjs-test" ] && echo "✓ nextjs-test exists" || echo "✗ nextjs-test missing"
          [ -d "deno-test" ] && echo "✓ deno-test exists" || echo "✗ deno-test missing"
          [ -d "astro-react-csr" ] && echo "✓ astro-react-csr exists" || echo "✗ astro-react-csr missing"
          [ -d "astro-react-bun-ssr" ] && echo "✓ astro-react-bun-ssr exists" || echo "✗ astro-react-bun-ssr missing"
          [ -d "tanstack-start-bun" ] && echo "✓ tanstack-start-bun exists" || echo "✗ tanstack-start-bun missing"
          [ -d "astro-react-askama" ] && echo "✓ astro-react-askama exists" || echo "✗ astro-react-askama missing"
          [ -d "scripts" ] && echo "✓ scripts exists" || echo "✗ scripts missing"

      - name: Install dependencies
        run: |
          # Tuono
          if [ -d "tuono-test" ]; then
            echo "Installing Tuono dependencies..."
            cd tuono-test
            npm install
            cd ..
          else
            echo "Warning: tuono-test directory not found"
          fi

          # Bun
          if [ -d "bun-test" ]; then
            echo "Installing Bun dependencies..."
            cd bun-test
            bun install
            cd ..
          else
            echo "Warning: bun-test directory not found"
          fi

          # Next.js
          if [ -d "nextjs-test" ]; then
            echo "Installing Next.js dependencies..."
            cd nextjs-test
            npm install
            cd ..
          else
            echo "Warning: nextjs-test directory not found"
          fi

          # Astro CSR
          if [ -d "astro-react-csr" ]; then
            echo "Installing Astro CSR dependencies..."
            cd astro-react-csr
            npm install
            cd ..
          fi

          # Astro Bun SSR
          if [ -d "astro-react-bun-ssr" ]; then
            echo "Installing Astro Bun SSR dependencies..."
            cd astro-react-bun-ssr
            bun install
            cd ..
          fi

          # TanStack Start
          if [ -d "tanstack-start-bun" ]; then
            echo "Installing TanStack Start dependencies..."
            cd tanstack-start-bun
            bun install
            cd ..
          fi

          # Astro Askama
          if [ -d "astro-react-askama" ]; then
            echo "Installing Astro Askama dependencies..."
            cd astro-react-askama
            npm install
            cd ..
          fi

      - name: Build projects
        run: |
          # Build Tuono
          if [ -d "tuono-test" ]; then
            echo "Building Tuono..."
            cd tuono-test
            echo "Running tuono build..."
            tuono build
            echo "Running cargo build..."
            cargo build --release
            cd ..
          else
            echo "Skipping Tuono build - directory not found"
          fi

          # Build Next.js
          if [ -d "nextjs-test" ]; then
            echo "Building Next.js..."
            cd nextjs-test
            npm run build
            cd ..
          else
            echo "Skipping Next.js build - directory not found"
          fi

          # Build Astro CSR
          if [ -d "astro-react-csr" ]; then
            echo "Building Astro CSR..."
            cd astro-react-csr
            npm run build
            cd ..
          fi

          # Build Astro Bun SSR
          if [ -d "astro-react-bun-ssr" ]; then
            echo "Building Astro Bun SSR..."
            cd astro-react-bun-ssr
            bun run build
            cd ..
          fi

          # Build TanStack Start
          if [ -d "tanstack-start-bun" ]; then
            echo "Building TanStack Start..."
            cd tanstack-start-bun
            bun run build
            cd ..
          fi

          # Build Astro Askama
          if [ -d "astro-react-askama" ]; then
            echo "Building Astro Askama..."
            cd astro-react-askama
            npm run build
            cargo build --release
            cd ..
          fi

      - name: Run benchmarks
        run: |
          if [ -f "scripts/run-benchmarks.sh" ]; then
            chmod +x scripts/run-benchmarks.sh
            ./scripts/run-benchmarks.sh
          else
            echo "Error: scripts/run-benchmarks.sh not found"
            exit 1
          fi

      - name: Upload benchmark results as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-results
          path: |
            reports/*.md
            logs/benchmark-report.md
            logs/*.log
            logs/system-info.txt
            .lighthouseci/**/*.json

      - name: Commit and Push Reports
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          # Create reports folder
          mkdir -p reports

          # Generate report filename with timestamp
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          REPORT_NAME="benchmark-$TIMESTAMP.md"

          # Copy generated report to reports folder
          if [ -f logs/benchmark-report.md ]; then
            cp logs/benchmark-report.md reports/$REPORT_NAME
          fi

          # Clean logs folder but keep .gitkeep if it exists
          find logs -type f ! -name '.gitkeep' -delete

          # Add log files to git
          git add logs/

          # Add and commit report
          git add reports/$REPORT_NAME
          git diff --quiet && git diff --staged --quiet || git commit -m "docs: Add benchmark report $REPORT_NAME [skip ci]"

          # Push changes
          git push
